const { Client } = require("@elastic/elasticsearch");
const word_list = require("./word_list");
const common_bulk = require("./common_bulk");
var fs = require('fs');
var env = require('dotenv');
env.config();

const client = new Client({
    node: process.env.elastic_ip,
    auth: {
        username: process.env.elastic_username,
        password: process.env.elastic_password
    },
    tls: {
        ca: fs.readFileSync('./http_ca.crt'),
        rejectUnauthorized: false
    }
});

async function deleteIndex(index) {
    console.log("deleting documents");
    await client.indices.delete({ index: index });
}
exports.deleteIndex = deleteIndex;

async function createIndex(del) {
    // if (del) {
    //     console.log("deleting index documents");
    //     await deleteIndex("documents");
    // }

    const exists = await client.indices.exists({ index: 'documents' });
    
    if (!exists) {
        console.log("Creating Index documents");
        client.indices.create({
            index: 'documents',
            "settings": {
                "analysis": {
                    "analyzer": {
                        "stem": {
                            "tokenizer": "standard",
                            "filter": [
                                "lowercase",
                                "stop", 
                                "unique"
                            ]
                        }, 
                        "dict": {
                            "tokenizer": "standard", 
                            "filter": ["dictionary_decompound"]
                        }
                    },
                    "filter": {
                        "dictionary_decompound": {
                            "type": "dictionary_decompounder",
                            "word_list": word_list, 
                            "min_subword_size": 4
                        }
                    }
                }
            }
        });
    }

    const exists2 = await client.indices.exists({ index: 'suggest' });
    if (!exists2) {
        console.log("Creating Suggest document");
        // client.indices.create({
        //     index: "suggest"
        // })
        client.bulk({
            body: common_bulk
        });
    }
}
exports.createIndex = createIndex;

async function CreateUpdateDocument(index, docID, name, content) {
    const res = await client.index({
        index: index,
        id: docID,
        body: {
            name: name, 
            content: content
        }
    });
    return res;
}
exports.CreateUpdateDocument = CreateUpdateDocument;

async function deleteDocument(index, id) {
    try {
        await client.client.delete({
            index: index,
            id: id
        })
    } catch {
        return null;
    }
}
exports.deleteDocument = deleteDocument;

async function makeData() {
    console.log("Adding in random data to documents");
    let names = ["Cooking Dirty", "Ancient Gonzo Wisdom", "Dangerous Games", "The Age Of Wonder", "A Bright And Guilty Place", "Genesis", "The Color of Lightning", "The Gone-Away World", "Awakening", "The Way Home", "firefly"];
    let contents = [
        `Prologue: Florida, 1998 We had this superstition in the kitchen: on Fridays, no one counted heads. No one counted tables at the end of the night, no one counted covers. When the last table was cleared, the dupes were just left there, mounded up on the spike. You didn't look, not even in secret. No one even guessed. Bad things would happen if you did. And even though no one looked, bad things happened anyway. Lane died on a Friday night due to complications of lifestyle--which is to say, he was shot by an acquaintance in a squabble over twenty dollars' worth of shitty brown horse. He wasn't found until Saturday morning; no one thought to call the restaurant to let us know that he wouldn't be coming in to work that day. He was just considered AWOL--a no-call/no-show that left the line a man short going into the early-bird rush. This was Tampa, Florida, in the middle nineties--a bad time for cuisine, a worse place. It wasn't a great time for me, either. Worse for Lane, I guess, but everything is a matter of degrees. Of right and wrong places, right and wrong times. Eventually, Lane's name was found in a late edition of the Tampa paper. Or maybe someone saw it on TV. I don't remember. In any event, we all found out, precisely too fucking late, that Lane was now fry-cooking in the sweet hereafter. The first hit was due in soon. And while there is a lot of voodoo in the air down in Florida, no one wanted to bet heavy on the long odds of Lane coming back as a zombie and retaking his place on the line. He'd been shit as a living cook anyhow. Being newly undead would probably only slow him worse than the smack had. "This is why cooks should always have the decency to die in a public place," said Floyd, the kitchen manager and nominal chef. "That way, they make the morning paper and we'd know who isn't showing up for work." In the kitchen, we discussed the best methods for dying in a spectacularly newsworthy fashion, and Floyd promoted one of the afternoon prep crew into Lane's slot on the line. The FNG--the Fucking New Guy--went on fryers. It was my fourth night on the line at Jimmy's Crab Shack, and no longer the F-ingest NG, I was brevetted to grill/steamer, working beside Sturgis, who was grill/top. Saturday night, early, no one was able to find a rhythm. We kept getting popped, then stalled, taking five tables like BangBangBang-BangBang, then nothing for ten minutes. The FNG fell into the weeds--dans la merde even at this stuttering half-speed. Jimmy, the owner, was antsy on expo, alternating between giggling fits and bouts of screaming obscenity. Floyd rotated the line out for cigarettes. He had a speed pourer filled with rum and hurricane mix in his rack that he sucked at like a baby with a bottle, and he jumped on every check out of the printer as if it were the harbinger of the rush that steadfastly refused to come. It was difficult to see from the grill station at one end of the line to the fryers at the other because of the wavy heat-haze--the air squirming, like staring through aquarium water. Five o'clock came and went. It seemed to me suddenly like there wasn't enough air on the line for all of us to breathe. I had chills. Cold flashes skittered up and down my spine while my front half baked. This being Florida and me being too young for menopause, I imagined it was malaria and stood firm, waiting for the hallucinations to kick in. With the ventilation hood going full blast, Roberto and Chachi couldn't keep the pilots on their unused burners going so had to keep kissing them back to life--leaning over and blowing across the palms of their hands to get the flame from one to jump to the next with the gas turned all the way up. The alternative method: smacking a pan down on the grate at an angle and hard enough to catch a spark. They did it over and over again until Floyd yelled at them to quit it. After that, they fought over the galley radio. After that, they amused themselves by drinking the cooking wine (sieved through a coffee filter to separate out all the grease and floating crap and then mixed with orange soda) and pegging frozen mushroom caps at Jimmy whenever his back was turned. At some point, Jimmy--in an attempt to catch whoever was throwing things at him, and half in the bag to begin with--spun around too fast, caught his foot on the edge of one of the kitchen mats and went down hard, his head spanging off the rounded edge of the expo table with a sound like someone throwing a melon at a gong. He was unconscious before he hit the floor. There was an instant of shocked silence, then a crashing wave of laughter. Seeing anyone fall down is funny, but seeing a drunken fat man fall down beats all. One of the waitresses ran for the hostess (who also doubled as FOH manager), and she came at the best sprint she could manage in her stiletto heels and stirrup pants. The prep/runner crew treated Jimmy like any other heat casualty, breaking in a wing and descending like Stukas to drag him clear of the flow of service. It took four of them. Jimmy was a big man and moving him was like trying to roll a beached whale back into the sea.`,
        `ABC News-February 20, 1967 Interview with reporter about Hell's Angels Reporter: You spent over a year with the Hell's Angels. What kind of an impression did you come out with of certain individuals? HST: It gives them recognition, a sense of companionship, group loyalty, and power. They get together and they can frighten people who might ordinarily frighten them. Especially now, since the California Attorney General did an official report on them, they've gotten a massive amount of attention and national publicity. They made the cover of the Saturday Evening Post, movies, this book . . . There would be no other way for these people to do this without going out and doing something like "The Boston Strangler" or "The Mad Bomber." It's an easy way to get what they can't get in the square world. It's a whole subculture of dropouts and washouts and people who just can't make it in this automated technological society. Reporter: How would you describe a typical Hell's Angels party? HST: It varies from big ones-the runs-to the continuing round of beer parties here and there. On a run, they might get 150 to 200 bikes to anywhere up to 300 in a state park somewhere. They park them in a big ring around a massive bonfire, sometimes 215 feet tall. And they'd buy about, oh, 100 dollars worth of beer just as a starter for the afternoon. They'll drink hundreds of dollars worth of beer in a matter of two or three days. They've actually cleaned out a whole town's beer supplies. At the same time, they're taking amphetamine pills . . . Reporter: LSD? HST: Well, that comes a little later. They start off with pills. Barbiturates and amphetamines, mixing them all together, then beer, then the wine starts, and later on there will be some LSD. Everything gets mixed in all together. Reporter: Mr. Thompson, what does your book attempt? HST: I just try to liken them to the other people-people like the Hell's Angels who don't wear the colors, like I say. There are thousands of losers and thugs, muggers and petty criminals, who would like to have this kind of attention but don't. Reporter: To summarize, how would you explain a Hell's Angel? HST: Well, he's between 20 and 40, though more likely around late 20s. He'd be a high school dropout. He'd have a minor police record with a lot of arrests and few convictions but not anything serious. Maybe a year or so in jail a few times for a small things. He'd be a motorcycle freak, a sort of lifetime bike rider. That would get him into the Hell's Angels. After that, he becomes sort of a creature of the club. And it gets more and more bizarre. His police record will start piling up because he's much more obvious. Reporter: You spent at least a year knowing them and living with them. What was your most vivid impressions of them? HST: Vivid impressions? Well, visually, there's no sight I can think of that compares to these Labor Day runs when they got several hundred of bikes out on the road. Reporter: What is a "run" exactly? HST: A run is just a sort of gigantic picnic or outing. They'd gather in one spot in the city then go to some sort of vacation in the mountains or the beach, or somewhere all together for a great big three-or four-day party. That's when they really frighten people because they're all together and they dress in the wildest way they can. They're all drunk out of their minds and eating pills. It's like an army of Huns has moved into your town. They don't necessarily go to destroy the place, but they work themselves into such a frenzy, and there are so many of them. Of course, the townspeople are all worried and frightened and carrying weapons and locking up their doors and locking up their daughters in the basement. That sort of thing. It creates a very tense situation. The slightest thing can blow into a riot or an attack, and the police can't really handle two or three hundred of them running wild without a lot of reinforcements. Reporter: Sometimes, in your book, I almost get the impression you're saying that their notoriety is overstated. HST: Yeah. The Hell's Angels themselves aren't as dangerous or are not nearly as much of a mess as they seem to be. But if you just drop it at that and go on to say "They're not so dangerous, go on and ignore them," then you missed the whole point I was getting at about the Hell's Angels being thousands of other losers just by some other name. I'm much more aware of it now after all this sort of thing. I see Hell's Angels everywhere and they don't wear colors. Even as far as Chicago.`,
        `Chapter One: The History Craze History, and not necessarily the sort that professional historians are doing, is widely popular these days, even in North America, where we have tended to look toward the future rather than the past. It can be partly explained by market forces. People are better educated and, particularly in the mature economies, have more leisure time and are retiring from work earlier. Not everyone wants to retire to a compound in the sun and ride adult tricycles for amusement. History can be helpful in making sense of the world we live in. It can also be fascinating, even fun. How can even the best novelist or playwright invent someone like Augustus Caesar or Catherine the Great, Galileo or Florence Nightingale? How can screenwriters create better action stories or human dramas than exist, thousand upon thousand, throughout the many centuries of recorded history? There is a thirst out there both for knowledge and to be entertained, and the market has responded with enthusiasm. Museums and art galleries mount huge shows around historical characters like Peter the Great or on specific periods in history. Around the world, new museums open every year to commemorate moments, often grim ones, from the past. China has museums devoted to Japanese atrocities committed during World War II. Washington, Jerusalem, and Montreal have Holocaust museums. Television has channels devoted entirely to history (often, it must be said, showing a past that seems to be made up largely of battles and the biographies of generals); historic sites are wilting under the tramp of tourists; history movies--think of all the recent ones on Queen Elizabeth I alone--are making money; and the proliferation of popular histories shows that publishers have a good idea of where profits are to be made. Ken Burns's documentaries, from the classic Civil War series to his one on World War II, are aired repeatedly. In Canada, Mark Starowicz's People's History drew millions of viewers. The Historica Minutes produced by the private foundation Historica, devoted to promoting Canadian history, are so popular among Canadian teenagers that they often do school projects where they make their own minutes. In the United Kingdom, David Starkey's series on British monarchs have made him rich and as famous as the kings and queens themselves. Many governments now have special departments devoted to commemorating the past--or, as it is often grandly designated, "heritage." In Canada, the Department of Canadian Heritage exhorts Canadians to learn about Canada's history, culture, and land: "Heritage is our collective treasure, given to us and ours to bequeath to our children." The term can encompass virtually anything: language, folk dances, recipes, antiques, paintings, customs, buildings. There are societies to celebrate antique cars or guns, baseball cards or matchboxes. In England, a young architect has founded the Chimneypot Preservation and Protection Society to save, as its mission decrees, "the Sentinels of Time." France, which has had a particularly active Ministry of Culture for decades, declared 1980 the Annee du Patrimoine. Locals dressed up to reenact the great moments of their history. In the following years, the number of heritage sites and monuments on the official list doubled. Scores of new museums--devoted to the wooden shoe, for example, or the chestnut forest--appeared. At the end of the decade, the government set up a special commission to oversee the commemoration of the two-hundredth anniversary of the French Revolution in 1989. In France there has been an explosion of reenactments of the past, festivals, and special months, weeks, and days. The possibilities, of course, are endless: the starts and ends of wars, the births and deaths of famous people, the first publication of a book or the first performance of an opera, a strike, a demonstration, a trial, a revolution, even natural disasters. And the activity is not all government inspired; much comes from local and volunteer initiatives. Chalons-sur-Marne recognized the centenary of the invention of canning. It is not just in France that communities want to revisit their past: Perth, Ontario, had a week of festivities in 1993 to celebrate the giant cheese that it sent to the World's Fair in Chicago in 1893. As enterprising local governments and businesses have realized, the past is also good for tourism.`,
        `Romanticism as a cultural force is generally regarded as intensely hostile to science, its ideal of subjectivity eternally opposed to that of scientific objectivity. But I do not believe this was always the case, or that the terms are so mutually exclusive. The notion of wonder seems to be something that once united them, and can still do so. In effect there is Romantic science in the same sense there is Romantic poetry, and often for the same enduring reasons. The first scientific revolution of the 17th century is familiarly associated with the names of Newton, Hooke, Locke and Descartes, and the almost simultaneous foundations of the Royal Society in London, and the Academie des Sciences in Paris. It existence has long been accepted, and the biographies of its leading figures are well known. But this second revolution was something different. The first person who referred to a "second scientific revolution" was probably the poet Coleridge in his Philosophical Lectures of 1819. It was inspired primarily by a sudden series of breakthroughs in the fields of astronomy and chemistry. It was a movement that grew out of 18th century Enlightenment rationalism, but largely transformed it, by bringing a new imaginative intensity and excitement to scientific work. It was driven by a common ideal of intense, even reckless, personal commitment to discovery. It was also a movement of transition. It flourished for a relative brief time, perhaps two generations, but produced long-lasting consequences — raising hopes and questions — that are still with us today. Romantic Science can be dated roughly, and certainly symbolically, between two celebrated voyages of exploration. These were Captain Cook's first round the world expedition aboard the Endeavour, begun in 1768; and Charles Darwin's voyage to the Galapagos islands aboard the Beagle begun in 1831. This was the time I have called the Age of Wonder, and with any luck we have not yet quite outgrown it. The idea of the exploratory voyage, often lonely and perilous, is in one form or another a central and defining metaphor of Romantic science. That is how William Wordsworth brilliantly transformed the great Enlightenment image of Sir Isaac Newton into a Romantic one. As a university student in the 1780's Wordsworth had often contemplated the full-size marble statue of Newton, with his severely close-cropped hair, that still dominates the stone-flagged entrance hall to the chapel of Trinity College, Cambridge. As Wordsworth originally put it, he could see a few yards off from his bedroom window, over the brick wall of St. John's College`,
        `'CHARLIE CRAWFORD AND EDITOR SLAIN!' screamed the headline in the Los Angeles Illustrated Daily News. The date was Thursday, March 20, 1931. At about 4.30 pm the previous afternoon the fifty-four year old Crawford, nicknamed the 'Gray Wolf' because of the silvery-gray hair that waved and curled across his head, had been gunned down in his office on Sunset Boulevard. Also killed was Herbert Spencer, a veteran journalist who'd been with Crawford in the room. 'EX-BOSS FALLS TO LONG-FEARED GUNMAN BULLET,' the News went on. 'Crawford, kingpin politician, lived until 8.32 p.m. last night, a little more than four hours after the shooting. He died without revealing the identity of his assailant, according to detectives ...' Crawford had been, and many believed still was, a 'boss', a key player in what was known as 'The System', a low-profile but all-powerful syndicate that ran the gambling, prostitution and bootlegging rackets in Los Angeles. This was L.A.'s brand of gangsterism: Crawford used officers of the Los Angeles Police Department to collect the take from the underworld captains; he worked behind the scenes with Kent Kane Parrot, a fixer who'd had George Cryer, the mayor of Los Angeles from 1921-29, pretty much in his pocket; it was a discreet yet effective arrangement, and had been in place since Crawford and Parrot contrived to get Cryer elected. As far as the rackets were concerned, L.A. had been a closed town ever since, locked down by Crawford and The System. 'It was the most lucrative, the most efficient, and the best-entrenched graft operation in the country,' News city editor Matt Weinstock wrote later. Now somebody was monkeying with that operation, trying to destroy it perhaps, or take it over. 'Racketeer bullets declared open warfare in the Los Angeles underworld yesterday,' said the L.A. Examiner. 'MAN HUNT ON!' An announcement went out over the newly perfected LAPD radio system: 'Wanted for murder — an American, about six feet tall, weighing between 150 and 175 pounds, and between 35 and 40 years of age. Hair, brown. A small black moustache. Dressed in neat blue suit and wearing sailor straw hat.' Was this the killer? It seemed so. 'The political structure rocked precariously while everybody tried to imagine who could have fired the fatal shots,' wrote Leslie White, a young detective working in the investigative unit of the District Attorney's office. For White, the case had a particular significance, a poignancy almost. He'd met Charlie Crawford several times, and had liked him. 'Despite the unanimous opinion that the murder of Crawford was a piece of civic betterment, I felt a pang,' White wrote. 'Would his death improve the city in any way? I doubted it. A new boss might be less efficiently corrupt. The King was dead — but who would seek the throne?' White worked downtown, in the Hall of Justice, a new building opposite the even newer white tower of City Hall. On that morning after the shootings White was in his small cubby-hole of an office, talking with colleagues, trying to figure out who could have pulled the trigger when his boss, Blayney Matthews, the burly and genial head of the D.A.'s investigative unit, came in with the news. 'We're looking for Dave Clark,' Matthews said. Leslie White blinked, unable, for a moment, to believe his ears. 'Our Dave Clark,' he said. 'That's right,' Matthews said, and White rocked back in his chair. Dave Clark — known to the press as 'Debonair Dave' or 'Handsome Dave' — was a crusading litigator and former assistant district attorney who was now running for judge. He was a war hero with matinee idol looks. He was, moreover, Leslie's White's friend. 'Had the chief suddenly accused me of the crime, I couldn't have been more astounded,' White wrote. Sorry to see Dave Clark's name in any way connected with this sensational crime, White hoped for the best, believing that at any moment Clark would arrive at the Hall of Justice and clear his name. But hours went by and nothing happened, and White himself became involved in the unavailing search for the suspect. Dave Clark had vanished, and was nowhere to be found.`,
        `Anax moved down the long corridor. The only sound was the gentle hiss of the air filter overhead. The lights were down low, as demanded by the new regulations. She remembered brighter days, but never spoke of them. It was one of the Great Mistakes, thinking of brightness as a quality of the past. Anax reached the end of the corridor and turned left. She checked the time. They would be watching her approach, or so it was rumored. The door slid open, quiet and smooth, like everything in The Academy zone. "Anaximander?" Anax nodded. The panel was made up of three Examiners, just as the regulations had promised. It was a great relief. Details of the examination were kept secret, and among the candidates rumors swirled. "Imagination is the bastard child of time and ignorance," her tutor Pericles liked to say, always adding "not that I have anything against bastards." Anax loved her tutor. She would not let him down. The door closed behind her. The Examiners sat behind a high desk, the top a dark slab of polished timber. "Make yourself comfortable." The Examiner in the middle spoke. He was the largest of the three, as tall and broad as any Anax had ever seen. By comparison the other two looked old and weak, but she felt their eyes upon her, keen and sharp. Today she would assume nothing. The space before them was clear. Anax knew the interview was being recorded. EXAMINER: Four hours have been allotted for your examination. You may seek clarification, should you have trouble understanding any of our questions, but the need to do this will be taken into consideration when the final judgment is made. Do you understand this? ANAXIMANDER: Yes. EXAMINER: Is there anything you would like to ask, before we begin? ANAXIMANDER: I would like to ask you what the answers are. EXAMINER: I'm sorry. I don't quite understand . . . ANAXIMANDER: I was joking. EXAMINER: Oh. I see. A bad idea. Not so much as a flicker of acknowledgment from any of them. Anax wondered whether she should apologize, but the gap closed quickly over. EXAMINER: Anaximander, your time begins now. Four hours on your chosen subject. The life and times of Adam Forde, 2058-2077. Adam Forde was born seven years into the age of Plato's Republic. Can you please explain to us the political circumstances that led to The Republic's formation? Was this a trick? Anax's topic clearly stated her area of expertise covered the years of Adam's life only. The proposal had been accepted by the committee without amendment. She knew a little of the political background of course, everybody did, but it was not her area of expertise. All she could offer was a classroom recitation, familiar to every student. This was no way to start. Should she challenge it? Were they expecting her to challenge it? She looked to their faces for clues, but they sat impassive as stone, offering her nothing. EXAMINER: Anaximander, did you understand the question? ANAXIMANDER: Of course I did. I'm sorry. I'm just . . . it doesn't matter . . . Anax tried to clear her mind of worries. Four hours. Plenty of time to show how much she knew. ANAXIMANDER: The story begins at the end of the third decade of the new millennium. As with any age, there was no shortage of doomsayers. Early attempts at genetic engineering had frightened large sectors of the community. The international economy was still oil based, and the growing consensus was that a catastrophic shortage loomed. What was then known as the Middle East remained a politically troubled region, and the United States - I will use the designations of the time for consistency - was seen by many to have embroiled itself in a war it could not win, with a culture it did not understand. While it promoted its interests as those of democracy, the definition was narrow and idiosyncratic, and made for a poor export.`,
        `When they first came into the country it was wet and raining and if they had known of the droughts that lasted for seven years at a time they might never have stayed. They did not know what lay to the west. It seemed nobody did. Sky and grass and red earth as far as they could see. There were belts of trees in the river bottoms and the remains of old gardens where something had once been planted and harvested and then the fields abandoned. There was a stone circle at the crest of a low ridge. Moses Johnson was a stubborn and secretive man who found statements in the minor prophets that spoke to him of the troubles of the present day. He came to decisions that could not be altered. He read aloud: Therefore thus saith the Lord: Ye have not harkened unto me in proclaiming liberty, every one to his own brother, and every man to his neighbor. Behold, I proclaim a liberty for you, saith the Lord, to the sword, to the pestilence, and to the famine, and I will make you to be removed into all the kingdoms of the earth. That's in Jeremiah, he said. So they left Burkett's Station, Kentucky, in 1863 in four wagons, fifteen white people and five black including children, to get away from the war between armies and also the undeclared war between neighbors. Britt Johnson was proud of his wife and he loved her and was deeply jealous of her because of her good looks and her singing voice and her unstinting talk and laughter. Her singing voice. All along their journey from Kentucky to north Texas he had been afraid for her. Afraid that some white man, or black, or Spaniard, would take a liking to her and he would have to kill him. He rode a gray saddle horse always within sight of the wagon that carried her and the children. She was as much of grace and beauty as he would ever get out of Kentucky. Before they crossed the Mississippi at Little Egypt they stopped and there at the heel of the free state of Illinois Moses Johnson caused Britt's manumission papers to be drawn up and notarized by a shabby consumptive justice of the peace who looked as if these papers were the last ones he would notarize before he died from sucking in the damp malarial air and the smoke of a black cigar. The justice of the peace said it was a shame to manumit the man, look at what a likely buck he was, a great big strong nigger, and Moses Johnson said, You are going to meet your Maker before long, sir. You will meet him with tobacco on your breath and smelling of the Indian devil weed, and what will you say to Him who is the Author of your being? You will say Yes I did my utmost to keep a human being in the bonds of slavery and robbed of his liberty, and moreover I spent my precious breath a-smoking of filthy black cigars. Here is the lawyer's signature on his papers and his wife's papers as well. You will have your clerk copy all of these and then deposit the copies in the Pulaski County Courthouse. And from there they went on to Texas. You could raise cattle anywhere in that country. At that time there was very little mesquite or underbrush, just the bluestem and the grama grasses and the low curling buffalo grass and the wild oats and buckwheat. When the wind ran over it they all bent in various yielding flows, with the wild buckwheat standing in islands, stiff with its heads of grain and red branching stems. The lower creek bottoms were like parks, with immense trees and no underbrush. The streams ran clearer than they do now. The grass held the soil in tight fists of roots. The streams did not always run but here and there were water holes whose edges were cut up with hoof marks of javelina and buffalo and sometimes antelope. Ducks flashed up off the surface and skimmed away in their flight patterns of beating and sailing, beating and sailing. Mary had been raised in the main house with old Mrs. Randall who was blind in one eye, and she had not wanted to come to Texas, even on the promise of her freedom. Britt said he would make it up to her. As soon as the country was settled and the war was over he would start in as a freighter. He would break in a team from some of the wild mustangs that ran loose in the plains. There had to be a way to catch them. Then he would buy heavy horses. And then they would have a good house and a big fenced garden and a cookstove and a kerosene lamp. The people who had come from Burkett's Station built their houses with large stone fireplaces and chimneys. They rode out into the country to explore. The tall grass hissed around the horses' legs like spray. Feral cattle ran in spotted and elusive herds, their horns as long as lances, splashed in red and white and some of them dotted like clown cattle. They had come to live on the very edge of the great Rolling Plains, with the forested country behind them and the empty lands in front. Long, attentive lines of timber ran like lost regiments along the rivers and creeks. Everything was strange to them: the cactus in all its hooked varieties, the elusive antelope in white bibs and black antlers, the red sandstone dug up in plates to build chimneys and fireplaces big enough to get into in case there was a shooting situation.`,
        `The lights went out in the Nameless Bar just after nine. I was bent over the pool table with one hand in the bald patch behind the D, which Flynn the Barman claimed was beer, but which was the same size and shape as Mrs. Flynn the Barman's arse: nigh on a yard in the beam and formed like the cross-section of a cooking apple. The fluorescent over the table blinked out, then came back, and the glass-fronted fridge gave a low, lurching hum. The wiring buzzed--and then it was dark. A faint sheen of static danced on the TV on its shelf, and the green exit lamp sputtered by the door. I dropped my weight into the imprint of Mrs. Flynn the Barman's hams and played the shot anyway. The white ball whispered across the felt, came off two cushions, and clipped the eight cleanly into a side pocket. Doff, doff, tchk . . . glonk. It was perfect. On the other hand, I'd been aiming for the six. I'd given the game to Jim Hepsobah, and any time now when the power came back and everything was normal in the Nameless Bar, I'd pass the cue to my hero pal Gonzo, and Jim would beat him too. Any time now. Except that the lights stayed out, and the hollow glimmer of the TV set faded away. There was a small, quiet moment, the kind you just have time to notice, which makes you feel sad for no good reason. Then Flynn went out back, swearing like billy-o--and if your man Billy-O ever met Flynn, if ever there was a cuss-off, a high noon kinduva thing with foul language, I know where my money'd be. Flynn hooked up the generator, which God help us was pig-powered. There was the sound of four large, foul-smelling desert swine being yoked to a capstan, a noise pretty much like a minor cavalry war, and then Flynn let loose some of his most abominable profanity at the nearest porker. It looked as if it wanted to vomit and bolted. The others perforce followed it in a slow but steady progression about the capstan, and then pig number one came back around, saw Flynn ready with another dose and tried to stop. Lashed to the crosspiece and bundled along by its three fellows, it found it couldn't, so it gathered its flabcovered self and charged past him at piggy top speed, and the whole cycle accelerated until, with a malodorous, oinking crunch, the generator kicked in, and the television lit up with the bad news. Or rather, it didn't light up. The picture was so dim that it seemed the set was broken. Then there were fireworks and cries of alarm and fear, very quiet but getting louder, and we realised Sally Culpepper was just now turning on the sound. The image shook and veered, and urgent men went past shouting get back, get clear, and ohshitlookatthatfuckerjesus, which they didn't even bother to bleep. In the middle distance, it looked as if maybe a figure was rolling on the ground. Something had gone absolutely, horribly awry in the world, and naturally some arsehole was present with a camera making himself 10k an hour hazard pay when he could have been rolling up his arsehole sleeves and saving a life or two. I knew a guy in the Go Away War who did just that, dumped the network's prized Digi VII in a latrine trench and hauled six civilians and a sergeant from a burning medical truck. Got the Queen's Honour back home and a P45 from his boss. He's in an institution now, is Micah Monroe, and every day two guys from the Veterans' Hospital come by and take him for a walk and make sure the medal's polished on its little stand by his bed. They're sweet old geezers, Harry and Hoyle, and they've got medals of their own and they figure it's the least they can do for a man who lost his mind to giving a damn. Harry's kid was in the medical truck, you see. One of the ones Micah couldn't reach. We stared at the screen and tried to make sense of what was on it. It looked, for a moment, as if the Jorgmund Pipe was on fire--but that was like saying the sky was falling. The Pipe was the most solidly constructed, triple-redundant, safety-first, one-of-a-kind necessary object in the world. We built it fast and dirty, because there was no other way, the gone-away world and then after that we made it indestructible. The plans were drawn up by the best, then checked and re-checked by the very best, and then the checkers themselves were scrutinised, analysed and vetted for any sign of fifth columnism or martyr tendencies, or even a serious and hitherto undetected case of just-plain-stupid, and then the contractors went to work under a scheme which emphasised thoroughness and adherence to spec over swift completion, and which imposed penalties so dire upon speculators and profiteers that it would actually be safer just to throw yourself from a high place, and finally the quantity surveyors and catastrophe experts went to town on it with hammers and saws, lightning generators and torsion engines, and declared it sound. Everyone in the Livable Zone was united in the desire to maintain and safeguard it. There was absolutely no chance that it could imaginably, conceivably, possibly be on fire.`,
        `Six days earlier How did it all begin? Well, I suppose it would be the day I rescued a newborn baby from a poisonous snake, heard the news of my mother's death and encountered my first ghost. Thinking about it, I could even pinpoint the time. A few minutes before six on a Friday morning and my quiet, orderly life went into meltdown. Seven minutes to six. I'd run hard. Panting, dripping with sweat, I found my key and pushed open the back door. The moment I did so my young charges started screeching. Rubbing a towel across the back of my neck I crossed the kitchen, lifted the lid of the incubator and looked down. There were three of them, hardly more than a handful apiece, hungry, grumpy balls of feathery fluff. Barn-owl chicks: two weeks old and orphaned just days after birth when their mother hit a large truck. A local birdwatcher had seen the dead owl and knew where to find the nest. He'd brought the chicks to the wildlife hospital where I'm the resident veterinary surgeon. They'd been close to death, cold and starving. They'd been starving ever since. I took a tray from the fridge, found a pair of tweezers and dangled a tiny, dead mouse into the incubator. It didn't last long. The chicks were thriving but, worryingly, getting far too used to me. Hand-rearing wild birds is tricky. Without some sort of human intervention, orphaned chicks will die; at the same time, they mustn't become dependent on humans. In a couple more weeks I was hoping to introduce them to avian foster-parents who would teach them the skills they needed to hunt and feed themselves. Until then I had to be careful. It was probably time to move them to an enclosed nesting box and start using a barn-owl-shaped glove puppet at mealtimes. Three minutes to six. I was heading upstairs for a shower when the phone rang, and I braced myself to be called in to deal with yet another roe deer run over on the A35. 'Miss Benning? Is that Miss Benning, the vet?' A young woman's voice. A very distressed young woman's voice. 'Yes, speaking,' I answered, wondering if I was going to get my shower after all. 'It's Lynsey Huston here. I live just up the road from you. Number 2. There's a snake in my baby's cot. I don't know what to do. I don't know what the hell to do.' Her voice was rising with every word; she seemed verging on hysteria. 'Are you sure?' Silly question, I know, but be fair, a snake in a cot isn't something you see every day. 'Of course I'm sure. I'm looking at it now. What the hell do I do?' She was too loud. 'Stay quiet and don't make any sudden movements.' I, on the other hand, was moving fast, out of the house, grabbing my car keys as I went, bleeping open the boot, reaching inside. 'Do you think it's bitten her?' I asked. Surprising myself, I remembered that the baby was a girl. I'd seen pink balloons outside the house a few weeks ago. 'I don't know. She looks like she's asleep. Oh God, what if she's not asleep?' 'Is her colour normal? Can you see her breathing?' I grabbed a couple of things from the back of the car and set off up the hill. I could see the Hustons' house, a sweet, whitewashed cottage at the top of the lane. The family was new to the village, had only lived there a few weeks, but I thought I could picture the mother, about my age, tallish, with shoulder-length fair hair. She and I had never spoken before. 'Yes, I think so; yes, she's pink. Can you come? Please say you can come.' 'I'm nearly there. The important thing is not to frighten the snake. Don't do anything to alarm it.' I pushed open the gate and ran up the path to the front door. It was locked. I ran round the back. The phone I was carrying was too far from its base station and began to beep at me. I switched it off and pushed at the back door. I was inside a brightly coloured, modern kitchen. For a house with a newborn baby it seemed remarkably tidy and clean. I put the phone down on the table and walked along the hall in the direction of the voice I could hear gabbling upstairs. As I approached the stairs I noticed damp patches and traces of mud on the otherwise spotless tiled floor. A familiar sound caught my attention. Glancing to the right I saw an incubator of newborn chicks in a small utility room. The family kept chickens.`,
        `Along with an escort guard, Thomas and Amanda Flynn walked out of the building towards the gatehouse, Thomas in front of Amanda, his heavy steps indenting the mud beneath his feet. Inmates, between classes and lunch, were moving from unit to unit, their arms behind their backs, one hand holding the wrist of the other, accompanied by a guard carrying a two-way radio. All of the boys were black. Flynn had seen one Hispanic kid, waxy-eyed and wired on meds, on his last visit, so maybe there were a few Spanish here, too, but that was immaterial to him. What weighed on him was that Chris was the sole white inmate of the facility. My son, here with all these... Flynn stopped himself before ugly words spelled themselves out in his head. He rang the bell on the door at the rear of the gatehouse, looking through bars and Plexiglas to get the attention of one of two uniformed women behind the counter. Like most of the female guard staff Flynn had seen here, these women were wide and generously weighted in the legs and hips. He and his wife were buzzed in, and passed through the same security aisle, similar to those used in airports, they'd entered. Neither of the guards looked at the couple nor spoke to them as Flynn and Amanda collected their keys and cells. They exited the gatehouse and walked along the chain link and razor wire fence to Amanda's SUV, parked in the staff and visitor's lot. They did not talk. Amanda was thinking of going to early mass on Sunday and lighting a candle for Chris. Flynn, as he often did, was thinking of what had gone wrong. By Flynn's reckoning, he had begun to lose his son somewhere in Chris's freshman year of high school. At the time, Chris was playing football and CYO basketball, getting decent grades, attending Sunday school and mass. He was also smoking marijuana, shoplifting, fighting other boys, and breaking into cars and lockers. This was all happening at the same time, when Chris was about fifteen. Flynn began to refer to his son as if he were two people: Good Chris and Bad Chris. By the age of sixteen, only Bad Chris remained. As a teenager and into his twenties, Flynn had blown his share of marijuana, so he detected Chris's use right away. Flynn could see the high in Chris's eyes, the way he would laugh inappropriately at violent images on the television screen, or his sudden interest in their lab mix, Darby, playing tug of war or wrestling him to the ground, something he would never do while straight. Of course, there was the smell that always hung in Chris's clothing and, when he had copped, that unmistakable skunky odor of fresh bud in his bedroom. It didn't bother Flynn horribly that his son smoked marijuana. In fact, he told Chris that he had no moral objection to it, but felt that it was, basically, a waste of time. That for an already marginal student like Chris, it could impede his progress. What bothered Flynn, what had become alarming, was that Chris began to smoke marijuana at the exclusion of everything else. He stopped playing sports. He stopped going to mass and hanging out with his church friends. He quit his job at the coffee shop in Friendship Heights. His grades edged towards failure. He seemed not to care about the loss, or what his degeneration was doing to his parents. Amanda still thought of Chris as her little boy, and couldn't bring herself to discipline him like a young man. Plus, she was certain that the Lord would step in and, when He deemed it appropriate, blow the black clouds away and give Chris the wisdom to get back on the righteous path. Flynn's response was elemental and not carefully considered. He believed in Darwin over fairy tales, and aimed to reinforce his position as the alpha dog of the house. He put Chris up against the wall more than once, raised his closed fist, and walked away before punching him. So Chris knew that his father was willing to cross the line and kick his ass, but the knowledge did nothing to alter his behavior. He didn't care.`, 
        `might sight fight height fire fly`
    ]

    // single insertion
    for (let i = 0; i < names.length; i++){
    // await client.index({
    //     index: 'documents',
    //     id: i, 
    //     body: {
    //         name: names[i],
    //         content: contents[i],
    //     }
    // })
        await CreateUpdateDocument('documents', i, names[i], contents[i]);
    }      
    await client.indices.refresh({ index: 'documents' });
}

async function searchDocument(index, searchTerms) {
    // await makeData();

    const results = await client.search({
        index: index,
        query: {
            multi_match: {
                query: searchTerms,
                analyzer: "stem",
                fields: [
                    "name",
                    "content"
                ]
            }
        },
        highlight: {
            fields: {
                content: {type: "plain"}, 
                name: {type: "plain"}
            }, 
            fragment_size: 500
        }
    });
    return results;
}
exports.searchDocument = searchDocument;

async function suggestDocument(index, suggestTerm) {
    const results = await client.indices.analyze({
        // index: index, 
        // analyzer: "dict", 
        // text: suggestTerm, 
        // min_subword_size: 5
        "tokenizer": "standard",
        "filter": [{
            "type": "dictionary_decompounder",
            "word_list": word_list,
            min_subword_size: 5
        }],
        "text": suggestTerm
    });
    let fullword = "";
    for (let i = 1; i < results.tokens.length; i++) {
        if (fullword.length < results.tokens[i].token.length) {
            fullword = results.tokens[i].token
        }
    }
    // console.log("fullword", fullword);
    let incomplete_word = suggestTerm.replace(fullword, '');
    // console.log("results", results);
    // console.log("nonfull word:", incomplete_word);
    let complete_words = await client.search({
        index: 'suggest', 
        size: 30,
        query: {
            fuzzy: {
                word: {
                    value: incomplete_word,
                    fuzziness: 2,
                    prefix_length: incomplete_word.length + 1
                }
            }
        }
    });
    
    let options = [];
    complete_words.hits.hits.forEach(word => {
        options.push(fullword + word._source.word);
    })
    return options;
}
exports.suggestDocument = suggestDocument;

// module.exports = client;